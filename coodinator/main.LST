C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\program tool\keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /***********************************
   2          ¼ì²â½ÓÊÕÊý¾Ý£¬½ÓÊÕµ½Êý¾ÝÔòµÆ2ÁÁ
   3          ¼ì²â½ÓÊÕÊý¾Ý¸ñÊ½ÊÇ·ñÕýÈ·£¬Êý¾ÝÍ·ÊÇAA£¬Î²ÊÇBB CC
   4          ¼ì²âÊý¾ÝÀ´Ô´µØÖ·£¬²¢ÖØÐÂ·ÖÅä¶ÌµØÖ·
   5          ½«ÕûÀíºóµÄÊý¾ÝÍ¨¹ý´®¿Ú1·¢ËÍ³öÈ¥£¬Êý¾Ý¸ñÊ½Îª£º¿ÕÆøÊª¶È£¬¿ÕÆøÎÂ¶È£¬ÍÁÈÀÊª¶È£¬ÍÁÈÀµçµ¼ÂÊ£¬¹âÕÕ¶È£¬¶ÌµØÖ·£¬»Ø³
             -µ ¿ÕÐÐ
   6          ¶¨Ê±Æ÷0ÓÃÀ´Ïû³ý½ÓÊÕÊý¾Ý³ö´íÊ±²úÉúµÄBUG£¬Í¨¹ý¶Ô½ÓÊÕ¼ÆÊýÇåÁãÀ´ÊµÏÖ£¨½«aÇåÁã£©£¬¶¨Ê±Ê±¼äÓÉtime0¾ö¶¨£¬4000Ïàµ±
             -ÓÚ20s
   7          ***********************************/
   8          #include <c8051f340.h>
   9          #include "def.h"
  10          #include "string.h"
  11          
  12          int  i,time0,k,kk;
  13          sbit LED1 = P0^6;                                                  // D7
  14          sbit LED2 = P0^7;                                                  // D8
  15          int  a = 0;
  16          
  17          bit                 clear_ask;                          // Çå³ý±êÖ¾Î»
  18          bit                                     receive_bit;                    // ½ÓÊÕ±êÖ¾Î»
  19          u8                                      receive_data[MAXBUF];   // ½ÓÊÕµ½µÄÊý¾Ý
  20          u8                                      Send_recv[10];              // ÐèÒª·¢ËÍµ½µçÄÔµÄÊý¾Ý
  21          tagZigbeePkg            recv_data;                              // ÒÑ½ÓÊÕµÄÊý¾Ý°ü
  22          tagZigbeeSendPkg        send_data;                              // ´ý·¢ËÍµÄÊý¾Ý°ü
  23          tagParaPkg          PaiSend;
  24          u8                                      shuju[7];
  25          u8                                      WeiBa[2];
  26          
  27          void SysclkInit(void);
  28          void PortInit(void);
  29          void Uart0Init(void);
  30          void Uart1Init(void);
  31          void InitAdc(void);
  32          u32  StartAdc(u8 Pxx);
  33          void SendAdc(void);
  34          void ZigbeeSend(void);
  35          void Ck1Send(u8 s[]);
  36          void TestZigbeeSend(void);
  37          void Timer0Init(void);
  38          void Delay(u16 i);
  39          void Delay_ms(u16 i);
  40          void Delay_s(u16 i);
  41          
  42          void main(void)
  43          {
  44   1              PCA0MD &= ~0x40;                                                // ½ûÖ¹¿´ÃÅ¹· 
  45   1              SysclkInit();                                                   // ³õÊ¼»¯ÊÇÏµÍ³Ê±ÖÓµ½12M
  46   1              Timer0Init();                                                   // ¶¨Ê±Æ÷0³õÊ¼»¯ÓÃÓÚÇå³þ½ÓÊÕÎ»
  47   1              PortInit();                                                             // ³õÊ¼¹Ò½»²æ¿ª¹ØºÍI/O¿Ú
  48   1              Uart0Init();                                                    // ³õÊ¼»¯UART0
  49   1              Uart1Init();                                                    // ³õÊ¼»¯UART1
  50   1              i    = 0;                                                               // ½ÓÊÕ¼ÆÊý
  51   1              clear_ask = 0;                                                  // Çå³ýÎ»
  52   1              time0 = 0;                                                              // ¶¨Ê±Æ÷0¼ÆÊý
  53   1              LED1 = 1;
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 2   

  54   1              LED2 = 0;
  55   1              Delay_ms(10);
  56   1              EA   = 1;                                                               // ¿ª×ÜÖÐ¶Ï
  57   1              ET0  = 1;                                                               // ¶¨Ê±Æ÷0ÖÐ¶ÏÔÊÐí
  58   1              ES0  = 1;                                                               // ¿ª´®¿Ú0ÖÐ¶Ï
  59   1              EIE2 = 0x02;                                                    // ¿ª´®¿Ú1ÖÐ¶Ï
  60   1              TR0  = 1;                                                               // ¶¨Ê±Æ÷0¿ªÊ¼
  61   1              while(1)
  62   1              {
  63   2                      if(receive_bit == 1)
  64   2                      {
  65   3                              ES0 = 0;                                                 //´®¿Ú0Í£Ö¹
  66   3                              TR0 = 0;                                                 // ¶¨Ê±Æ÷0Í£Ö¹
  67   3                              receive_bit = 0;
  68   3                              LED2 = 1;
  69   3                              if(recv_data.u8_array[12] == 0xCC)                                                //ÅÐ¶ÏÊý¾Ý¸ñÊ½ÊÇ·ñÕýÈ·
  70   3                              {
  71   4                                       if(recv_data.u8_array[11] == 0xBB)
  72   4                                       {
  73   5                                              if(recv_data.u8_array[4] == 0xAA)
  74   5                                              {
  75   6                                                      for(k=0; k<6;k++)                                                               //½«Êý¾Ý¸´ÖÆµ½·¢ËÍÊý×éÖÐ
  76   6                                                      {
  77   7                                                              PaiSend.u8_array[k]=recv_data.u8_array[5+k];
  78   7                                                      }
  79   6                                                      if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x01)                   //ÅÐ¶ÏÀ´Ô´µØÖ·
  80   6                                                      {
  81   7                                                              PaiSend.u8_array[6] = 0x01;
  82   7                                                      }
  83   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x02)
  84   6                                                      {
  85   7                                                              PaiSend.u8_array[6] = 0x02;
  86   7                                                      }
  87   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x03)
  88   6                                                      {
  89   7                                                              PaiSend.u8_array[6] = 0x03;
  90   7                                                      }
  91   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x04)
  92   6                                                      {
  93   7                                                              PaiSend.u8_array[6] = 0x04;
  94   7                                                      }
  95   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x05)
  96   6                                                      {
  97   7                                                              PaiSend.u8_array[6] = 0x05;
  98   7                                                      }
  99   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x00&&recv_data.ZigbeePkg.mac[1]==0x90)
 100   6                                                      {
 101   7                                                              PaiSend.u8_array[6] = 0x06;
 102   7                                                      }
 103   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x50&&recv_data.ZigbeePkg.mac[1]==0xF5)
 104   6                                                      {
 105   7                                                              PaiSend.u8_array[6] = 0x07;
 106   7                                                      }
 107   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x06&&recv_data.ZigbeePkg.mac[1]==0xBC)
 108   6                                                      {
 109   7                                                              PaiSend.u8_array[6] = 0x08;
 110   7                                                      }
 111   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x0A&&recv_data.ZigbeePkg.mac[1]==0x19)
 112   6                                                      {
 113   7                                                              PaiSend.u8_array[6] = 0x09;
 114   7                                                      }
 115   6                                                      else if(recv_data.ZigbeePkg.mac[0]==0x0D&&recv_data.ZigbeePkg.mac[1]==0x76)
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 3   

 116   6                                                      {
 117   7                                                              PaiSend.u8_array[6] = 0x0A;
 118   7                                                      }
 119   6                                                      else 
 120   6                                                      {
 121   7                                                              PaiSend.u8_array[6] = 0;                                                                                                  //ÈôÀ´Ô´µØÖ·²»ÕýÈ·ÔòµØÖ·Îª0
 122   7                                                      }
 123   6                                                      PaiSend.u8_array[7] = 0x0d;
 124   6                                                      PaiSend.u8_array[8] = 0x0a;
 125   6                                                      if(PaiSend.u8_array[6] == 0)
 126   6                                                      {       
 127   7                                                              for(k=0; k<9;k++)
 128   7                                                              {
 129   8                                                                      PaiSend.u8_array[k]=0;
 130   8                                                              }                                       
 131   7                                                      }
 132   6                                                      else
 133   6                                                      {
 134   7                                                              Ck1Send(PaiSend.u8_array);
 135   7                                                              i = 0;                                                                   //½«½ÓÊÕÖ¸ÕëÖ¸ÏòµÚ0Î»
 136   7                                                              for(k=0; k<ZIGBEE_LEN;k++)                               //½«½ÓÊÕ×Ö¶ÎÇåÁã
 137   7                                                              {
 138   8                                                                      recv_data.u8_array[k] = 0;
 139   8                                                              }
 140   7                                                              for(k=0; k<9;k++)                                                //½«·¢ËÍ×Ö¶ÎÇåÁã
 141   7                                                              {
 142   8                                                                      PaiSend.u8_array[k]=0;
 143   8                                                              }
 144   7                                                      }                                               
 145   6                                              }
 146   5                                       }
 147   4                              }       
 148   3                              LED2 = 0;
 149   3                              ES0 = 1;
 150   3                              TR0 = 1;
 151   3                      }
 152   2                      if(clear_ask == 1)
 153   2                      {
 154   3                              TR1 = 0;
 155   3                              clear_ask = 0;
 156   3                              i = 0;                                                                   //½«½ÓÊÕÖ¸ÕëÖ¸ÏòµÚ0Î»
 157   3                              for(k=0; k<ZIGBEE_LEN;k++)                               //½«½ÓÊÕ×Ö¶ÎÇåÁã
 158   3                              {
 159   4                                      recv_data.u8_array[k] = 0;
 160   4                              }
 161   3                              for(k=0; k<9;k++)                                                //½«·¢ËÍ×Ö¶ÎÇåÁã
 162   3                              {
 163   4                                      PaiSend.u8_array[k]=0;
 164   4                              }
 165   3                              TR1 = 1;        
 166   3                      }
 167   2              }
 168   1              
 169   1      }
 170          
 171          
 172          
 173          
 174          
 175          /********************************************************************
 176          * ¹¦ÄÜ : ÏµÍ³Ê±ÖÓ³õÊ¼»¯
 177          * ÊäÈë : ÎÞ
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 4   

 178          * Êä³ö : ÎÞ
 179          ***********************************************************************/
 180          
 181          void SysclkInit(void)
 182          {
 183   1              REG0CN = 0x00;                                                  // ÎÈÑ¹Æ÷Ê¹ÄÜ 
 184   1              OSCICN |= 0x83;                                                 // ²»·ÖÆµ,Ê¹ÓÃÄÚ²¿12M¾§Õñ,ÏµÍ³Ê±ÖÓÆµÂÊÎª12MHz
 185   1              OSCICL = 0x00;                                                  // ÄÚ²¿¾§Õñ¹¤×÷ÔÚ×î¸ßÆµÂÊ
 186   1              OSCLCN = 0x00;                                                  // ½ûÖ¹ÄÚ²¿L-FÕñµ´Æ÷
 187   1              OSCXCN = 0x00;                                                  // ¹Ø±ÕÍâ²¿Õñµ´Æ÷
 188   1              TMOD = 0;                                                               // ¶¨Ê±Æ÷·½Ê½¼Ä´æÆ÷³õÊ¼»¯
 189   1              CKCON = 0;                                                              // Ê±ÖÓ¿ØÖÆ¼Ä´æÆ÷³õÊ¼»¯
 190   1      }
 191          
 192          /********************************************************************
 193          * ¹¦ÄÜ : ¶Ë¿Ú³õÊ¼»¯
 194          * ÊäÈë : ÎÞ
 195          * Êä³ö : ÎÞ
 196          ***********************************************************************/
 197          
 198          void PortInit(void)
 199          {
 200   1              P0MDOUT = 0xd0;                                                 // ÉèÖÃÁ½ÕµµÆºÍP0.4£¨¶ÔÓ¦TX0£©Êä³öÎªÍÆÍì·½Ê½
 201   1      //      P1MDOUT = 0x03;                                                 // ÉèÖÃÁ½ÕµµÆÊä³öÎªÍÆÍì·½Ê½
 202   1              P2MDOUT = 0x01;                                                 // ÉèÖÃP2.0£¨¶ÔÓ¦TX1£©Êä³öÎªÍÆÍì·½Ê½
 203   1      //      P3MDOUT = 0x40;                                                 // ÉèÖÃP3.6£¨¼ÌµçÆ÷£©Êä³öÎªÍÆÍì·½Ê½
 204   1      //      P3MDIN  = 0xCE;                                                 // ÉèÖÃP3.1,P3.4,P3.5ÎªÄ£ÄâÊäÈë
 205   1              P0SKIP  = 0xcf;                                                 // ½»²æ¿ª¹ØÌø¹ýP0ºÍP1£¨²»ÄÜÌø¹ýP0.4ºÍP0.5£©£¬Ê¹P2.0ºÍP2.1³ÉÎªTX1ºÍRX1
 206   1              P1SKIP  = 0xff;
 207   1              XBR0 = 0x01;                                                    // UART TX0, RX0 Á¬µ½¶Ë¿ÚÒý½Å P0.4 ºÍ P0.5¡£
 208   1              XBR2 = 0x01;                                                    // UART1 TX1, RX1 Á¬µ½¶Ë¿ÚÒý½Å P0.0 ºÍ P2.1¡£
 209   1              XBR1 = 0x40;                                                    // ½»²æ¿ª¹ØÊ¹ÄÜ²¢ÈõÉÏÀ­
 210   1      }
 211          
 212          /******************************************************************** 
 213          * ¹¦ÄÜ : ´®¿Ú0³õÊ¼»¯
 214          * ÊäÈë : ÎÞ
 215          * Êä³ö : ÎÞ
 216          ***********************************************************************/
 217          
 218          void Uart0Init(void)
 219          {
 220   1              SCON0 = 0x50;                                                   // SCON0:Ä£Ê½1,8Î»UART,Ê¹ÄÜRX
 221   1              TMOD |= 0x20;                                                   // TMOD: ¶¨Ê±Æ÷¹¤×÷ÔÚÄ£Ê½2, 8Î»ÖØÔØ
 222   1              TH1 = 256 - (SYSCLK / BAUDRATE / 8);    // ÉèÖÃ¶¨Ê±1ÓÃ×÷²¨ÌØÂÊµÄÖØÔØÖµ
 223   1              TR1 = 1;                                                                // ¿ª¶¨Ê±Æ÷1
 224   1              CKCON |= 0x01;                                                  // ¶¨Ê±Æ÷1ÓÃ(ÏµÍ³Ê±ÖÓ/4)×÷ÎªËüµÄÊ±»ù
 225   1              TI0 = 0;                                                                // Çå·¢ËÍ±êÖ¾Î»
 226   1      }
 227          
 228          /******************************************************************** 
 229          * ¹¦ÄÜ : ´®¿Ú1³õÊ¼»¯
 230          * ÊäÈë : ÎÞ
 231          * Êä³ö : ÎÞ
 232          ***********************************************************************/
 233          void Uart1Init(void)
 234          {
 235   1         u16     sbrl;
 236   1         sbrl = 65536 - (SYSCLK/BAUDRATE/2); // ¼ÆËãUART1×¨ÓÃ¼ÆÊýÆ÷ÓÃ×÷²¨ÌØÂÊµÄÖØÔØÖµ£¬Ô¤·ÖÆµ = 1
 237   1         SBRLL1 = sbrl & 0x00ff;                         // ÉèÖÃUART1 ²¨ÌØÂÊ·¢ÉúÆ÷ÖØÔØÖµµÍ×Ö½Ú
 238   1         SBRLH1 = sbrl / 256;                            // ÉèÖÃUART1 ²¨ÌØÂÊ·¢ÉúÆ÷ÖØÔØÖµ¸ß×Ö½Ú
 239   1         SBCON1 |= 0x43;                                         // SBCON1:²¨ÌØÂÊ·¢ÉúÆ÷Ê¹ÄÜ,Ô¤·ÖÆµ = 1
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 5   

 240   1         SCON1 = 0x30;                                           // SCON1:Ê¹ÄÜRX
 241   1         SMOD1 = 0x0c;                       // SMOD1:¶à´¦ÀíÆ÷Í¨ÐÅ½ûÖ¹£¬Ó²¼þÆæÅ¼Î»½ûÖ¹,8Î»Êý¾Ý,¶îÍâÎ»½ûÖ¹,Í£Ö¹Î»
             -³¤¶È1
 242   1      }
 243          
 244          
 245          
 246          /******************************************************************** 
 247          * ¹¦ÄÜ : ´®¿Ú1·¢ËÍÊý¾Ý³ÌÐò
 248          * ÊäÈë : ÎÞ
 249          * Êä³ö : ÎÞ
 250          ***********************************************************************/
 251          void Ck1Send(u8 s[])
 252          {       
 253   1              int j;
 254   1              Delay_ms(10);                                                            
 255   1              EIE2 = 0;                                                       // ¹Ø´®¿Ú1ÖÐ¶Ï
 256   1              for (j = 0; j < PAI_SEND_LEN; j++)
 257   1              {
 258   2                      SBUF1 = s[j];                           // ½«½ÓÊÕµ½Êý¾ÝËÍ³ö
 259   2                      while(!(SCON1 & 0x02)) NOP;             // ·¢ËÍ±êÖ¾Î»ÊÇ·ñ²úÉú
 260   2                      SCON1 &= (~0x02);                               // Çå·¢ËÍ±êÖ¾Î»
 261   2                      Delay(100);                                             // ÑÓÊ±                                                                 
 262   2              }
 263   1              EIE2 = 0x02;                                            // ¿ª´®¿Ú1ÖÐ¶Ï
 264   1      
 265   1      }
 266          
 267          /********************************************************************
 268          * ¹¦ÄÜ : ´®¿Ú0ÖÐ¶Ï£¬½ÓÊÕÍêÊý¾ÝºóÖÃÎ»
 269          * ÊäÈë : ÎÞ
 270          * Êä³ö : ÎÞ
 271          ***********************************************************************/
 272          void Uart0Isr(void) interrupt 4
 273          {
 274   1              if (!TI0)                                                               // ÊÇ·¢ËÍÖÐ¶Ï»¹ÊÇ½ÓÊÕÖÐ¶Ï
 275   1              {
 276   2                      RI0 = 0;                                                        // Çå½ÓÊÕ±êÖ¾Î»
 277   2                      recv_data.u8_array[i++] = SBUF0;        // ±£´æ½ÓÊÕµ½µÄÊý¾Ý
 278   2                      if (i == ZIGBEE_LEN)
 279   2                      {
 280   3                              receive_bit = 1;                                // ÖÃ½ÓÊÕ±êÖ¾
 281   3                              i = 0;
 282   3                      }
 283   2              }
 284   1              TI0 = 0;                                                                // Çå·¢ËÍ±êÖ¾Î»
 285   1      }
 286          
 287          /********************************************************************
 288          * Ãû³Æ : Timer0Init() 
 289          * ¹¦ÄÜ : C8051F340µÄTIMER0µÄ³õÊ¼»¯£¬OX150A¶ÔÓ¦ÑÓÊ±5MS
 290          * ÊäÈë : ÎÞ
 291          * Êä³ö : ÎÞ
 292          ***********************************************************************/
 293          void Timer0Init(void)
 294          {
 295   1              CKCON |= 0x04;                                                  // ¶¨Ê±Æ÷0Ê¹ÓÃÏµÍ³Ê±ÖÓ12M
 296   1              TMOD |= 0x01;                                                   // ¶¨Ê±Æ÷0Ê¹ÓÃ16Î»¶¨Ê±Æ÷·½Ê½
 297   1              TH0 = 0x15;                                                             // ´Ë¶¨Ê±Æ÷³õÊ¼Öµ¶ÔÓ¦¶¨Ê±5MS
 298   1              TL0 = 0xa0;
 299   1      }
 300          
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 6   

 301          
 302          
 303          /********************************************************************
 304          * Ãû³Æ : Timer0Isr() 
 305          * ¹¦ÄÜ : ¶¨Ê±Æ÷ÖÐ¶Ï0·þÎñ×Ó³ÌÐò
 306          * ÊäÈë : ÎÞ
 307          * Êä³ö : ÎÞ
 308          ***********************************************************************/
 309          
 310          void Timer0Isr(void) interrupt 1
 311          {
 312   1              ET0 = 0;                                                        // ¹Ø¶¨Ê±Æ÷0ÖÐ¶Ï
 313   1              TF0 = 0;                                                        // ÇåÖÐ¶Ï±êÖ¾Î»
 314   1              time0++;
 315   1              if(time0==4000)
 316   1              {
 317   2                      time0=0;
 318   2                      clear_ask = 1;  
 319   2              }
 320   1              TR0 = 1;                                                        // ¿ª¶¨Ê±Æ÷0
 321   1              ET0 = 1;                                                        // ¿ª¶¨Ê±Æ÷0ÖÐ¶Ï
 322   1              
 323   1      }
 324          
 325          
 326          /******************************************************************** 
 327          * ¹¦ÄÜ : ÑÓÊ±×Ó³ÌÐò
 328          * ÊäÈë : ÎÞ
 329          * Êä³ö : ÎÞ
 330          ***********************************************************************/
 331          
 332          void Delay(u16 i)
 333          {
 334   1              while (i--)
 335   1              {
 336   2                      NOP;
 337   2                      NOP;
 338   2                      NOP;
 339   2              }
 340   1      }
 341          
 342          /********************************************************************
 343          * ¹¦ÄÜ : ³¤ÑÓÊ±×Ó³ÌÐò
 344          * ÊäÈë : ÎÞ
 345          * Êä³ö : ÎÞ
 346          ***********************************************************************/
 347          
 348          void Delay_ms(u16 i)
 349          {
 350   1              while(i--)
 351   1              {
 352   2                      Delay(0xffff);
 353   2              }
 354   1      }
 355          
 356          void Delay_s(u16 i)
 357          {
 358   1              while(i--)
 359   1              {
 360   2                      Delay_ms(10);
 361   2              }       
 362   1      }
C51 COMPILER V9.00   MAIN                                                                  09/26/2017 15:16:29 PAGE 7   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1094    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    127       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
